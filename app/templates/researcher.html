{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ researcher.name }} - Researcher Profile</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #ccc; padding: 32px; }
        .header { display: flex; align-items: center; }
        .name { font-size: 2em; font-weight: bold; margin-right: 24px; }
        .uni { font-size: 1.0em; color: #949494; margin-top: 10px; }
        .level { font-size: 1.2em; color: #555; margin-top: 10px; margin-bottom: 32px;}
        .department { font-size: 1.0em; color: #949494; margin-top: 10px;}
        .section-title { font-size: 1.2em; font-weight: bold; margin: 32px 0 12px 0; }
        .pub-table { width: 100%; border-collapse: collapse; }
        .pub-table th, .pub-table td { border: 1px solid #bbb; padding: 10px 16px; text-align: left; }
        .pub-table th { background: #e3e3e3; cursor: pointer; user-select: none; }
        .arrow { margin-left: 6px; font-size: 0.8em; opacity: 0.6; }
        .hidden { display: none; }
        #searchInput { margin: 10px 0; padding: 6px 8px; width: 240px; }
        a { color: #000000; text-decoration: none; }
        a:hover { color: #0d47a1; text-decoration: underline; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="name"><a href="{{ researcher.profile_url }}">{{ researcher.name }}</a></div>
        </div>
        <div class="uni">{{ researcher.university }}</div>
        <div class="department">{{ researcher.department }}</div>
        <div class="level">{{ researcher.level }}</div>

        <input type="text" id="searchInput" placeholder="Filter publications…">

        <table class="pub-table" id="pub-table">
            <thead>
            <tr>
                <th data-type="text">Publications Title <span class="arrow"></span></th>
                <th data-type="text">Journal Name <span class="arrow"></span></th>
                <th data-type="number">Year <span class="arrow"></span></th>
                <th data-type="text">ABDC Ranking <span class="arrow"></span></th>
                <th data-type="number">h-index <span class="arrow"></span></th>
            </tr>
            </thead>
            <tbody>
            {% for pub in publications %}
            <tr>
                <td>{{ pub.title }}</td>
                <td>{{ pub.journal }}</td>
                <td>{{ pub.year }}</td>
                <td>{{ pub.ranking }}</td>
                <td>{{ pub.h_index }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- sorting and filtering can still be improved -->
    <script>
        const table = document.getElementById('pub-table');
        const tbody = table.tBodies[0];
        const headers = table.tHead.rows[0].cells;
        const sortState = Array.from(headers).map(() => null);

        const getCellText = (tr, idx) =>
            (tr.children[idx]?.textContent || '').trim();

        const asNumber = (v) => {
            const cleaned = v.replace(/[, ]+/g, '');
            return parseFloat(cleaned);
        };

        const compareFactory = (idx, dir, type) => {
            const mul = dir === 'asc' ? 1 : -1;
            return (a, b) => {
                let va = getCellText(a, idx);
                let vb = getCellText(b, idx);
                if (type === 'number') {
                    const na = asNumber(va);
                    const nb = asNumber(vb);
                    if (!Number.isNaN(na) && !Number.isNaN(nb)) {
                        return (na - nb) * mul;
                    }
                }
                return va.localeCompare(vb, undefined, { numeric: true, sensitivity: 'base' }) * mul;
            };
        };

        function renderSortArrows(activeIdx) {
            Array.from(headers).forEach((th, i) => {
                const arrow = th.querySelector('.arrow');
                if (!arrow) return;
                if (i === activeIdx) {
                    arrow.textContent = sortState[i] === 'asc' ? '▲' : '▼';
                } else {
                    arrow.textContent = '';
                }
            });
        }

        Array.from(headers).forEach((th, idx) => {
            th.addEventListener('click', () => {
                sortState[idx] = sortState[idx] === 'asc' ? 'desc' : 'asc';
                sortState.forEach((_, i) => { if (i !== idx) sortState[i] = null; });

                const type = th.dataset.type || 'text';
                const dir = sortState[idx] || 'asc';

                const rows = Array.from(tbody.querySelectorAll('tr'))
                    .sort(compareFactory(idx, dir, type));

                rows.forEach(row => tbody.appendChild(row));
                renderSortArrows(idx);
            });
        });

        document.getElementById('searchInput').addEventListener('input', function () {
            const q = this.value.toLowerCase();
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                const text = tr.textContent.toLowerCase();
                tr.classList.toggle('hidden', !text.includes(q));
            });
        });
    </script>
</body>
</html>
{% endblock %}